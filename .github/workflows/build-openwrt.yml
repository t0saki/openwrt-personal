name: Build OpenWrt Firmware

on:
  push:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        branch: [master, v23.05.3]  # Specify branches to be built

    steps:
    - name: Checkout your repository
      uses: actions/checkout@v3

    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        # this might remove tools that are actually needed,
        # if set to "true" but frees about 6 GB
        tool-cache: false
        
        # all of these default to true, but feel free to set to
        # "false" if necessary for your workflow
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: false
        swap-storage: true

    - name: Set up the build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget

    - name: Clone ImmortalWrt source code
      run: |
        git clone -b ${{ matrix.branch }} --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt
        cd immortalwrt

    - name: Copy custom .config
      run: |
        cp ${{ github.workspace }}/.config immortalwrt/.config

    - name: Update and install feeds
      run: |
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build firmware
      run: |
        cd immortalwrt
        make -j$(nproc) defconfig download clean world
        # make defconfig
        # make -j$(nproc)
        # make -j1 V=s
      continue-on-error: true

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: openwrt-firmware-${{ matrix.branch }}
        path: immortalwrt/
      continue-on-error: true

    - name: Upload firmware to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          immortalwrt/bin/targets/x86/64/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Create a release
      if: github.ref == 'refs/heads/master'
      run: |
        gh release create ${{ matrix.branch }} \
          --title "${{ matrix.branch }} Build" \
          --notes "Build of the ${{ matrix.branch }} branch" \
          "immortalwrt/bin/targets/x86/64/*"
      continue-on-error: true